// ============================================================
// üîê REGLAS DE SEGURIDAD COMPLETAS - CIELO PROMO MULTI-PA√çS
// ============================================================
// Arquitectura empresarial con 4 roles: SUPER_ADMIN, ADMIN_COUNTRY, DISTRIBUTOR, STORE
// ============================================================

rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========== üõ°Ô∏è FUNCIONES AUXILIARES ==========
    
    // üîê SUPER_ADMIN - Definido directamente en las REGLAS
    // NO depende de la colecci√≥n /users
    // Verificaci√≥n por email o claim personalizado
    function isSuperAdmin() {
      return request.auth != null && (
        request.auth.token.email == 'hectorcobea03@gmail.com' ||
        request.auth.token.admin == true
      );
    }

    // Verificar si el usuario est√° autenticado
    function isAuth() {
      return request.auth != null;
    }

    // Obtener documento del usuario actual
    function getUser() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Verificar rol del usuario (para ADMIN_COUNTRY, DISTRIBUTOR, STORE)
    function isRole(role) {
      return isAuth() && getUser().role == role;
    }

    // Verificar si es ADMIN_COUNTRY (desde colecci√≥n /users)
    function isAdminCountry() {
      return isRole('ADMIN_COUNTRY');
    }

    // Verificar si es DISTRIBUTOR (desde colecci√≥n /users)
    function isDistributor() {
      return isRole('DISTRIBUTOR');
    }

    // Verificar si es STORE (desde colecci√≥n /users)
    function isStore() {
      return isRole('STORE');
    }

    // Verificar si el usuario pertenece a un pa√≠s
    function belongsToCountry(countryId) {
      return isAuth() && getUser().countryId == countryId;
    }

    // Verificar si el usuario es distribuidor espec√≠fico
    function isDistributorId(distributorId) {
      return isAuth() && getUser().distributorId == distributorId;
    }

    // Verificar si el usuario es propietario de una tienda
    function ownsStore(storeId) {
      return isAuth() && getUser().storeId == storeId;
    }

    // ‚ú® VERIFICAR SI EXISTE ADMIN EN UN PA√çS (CORAZ√ìN DEL SISTEMA)
    // Sin admin de pa√≠s, no puede haber tenderos en ese pa√≠s
    // Nota: En Firestore Rules no podemos hacer queries complejas
    // La validaci√≥n principal ocurre en el backend (Cloud Functions)
    // Esta regla solo previene creaci√≥n directa sin pasar por validaci√≥n
    function hasCountryAdmin(countryId) {
      return countryId != null && true; // Validaci√≥n delegada al backend en authService
    }

    // ========== üë§ COLLECTION: users ==========
    // üìù NOTA: Usuarios creados por:
    //    - Registro desde cliente (registerUserWithoutCode, registerStore)
    //    - Script de load/inicializaci√≥n de c√≥digo
    //    - SUPER_ADMIN NO est√° en esta colecci√≥n, est√° definido en las REGLAS
    match /users/{uid} {
      // Lectura: 
      // - El usuario puede leer su propio documento
      // - SUPER_ADMIN puede leer cualquiera
      // - ESPECIAL: Cualquier usuario puede leer ADMIN_COUNTRY (para buscar admin de pa√≠s durante registro)
      // - ESPECIAL: Permitir lectura de documentos espec√≠ficos sin autenticaci√≥n para el flujo de registro
      //   (b√∫squeda de distribuidores creados por admin regional)
      // - ESPECIAL: Un usuario autenticado puede leer cualquier DISTRIBUTOR (para perfil y panel de distribuidor)
      allow read: if request.auth.uid == uid || 
                     isSuperAdmin() ||
                     resource.data.role == 'ADMIN_COUNTRY' ||
                     (isAuth() && resource.data.role == 'DISTRIBUTOR') ||  // ‚Üê Cualquier usuario autenticado puede leer DISTRIBUTOR
                     resource.data.role == 'DISTRIBUTOR';  // ‚Üê Permitir lectura de DISTRIBUTOR sin auth para registro

      // Queries: Permitir buscar a ADMIN_COUNTRY sin importar autenticaci√≥n (durante registro)
      // Tambi√©n permitir buscar usuarios de tu mismo pa√≠s si est√°s autenticado
      // Tambi√©n permitir buscar DISTRIBUTOR si est√° autenticado
      allow list: if true;  // TEMPORARY: Debug mode - allow all queries

      // Escritura durante creaci√≥n: El usuario crea su propio documento DURANTE registro
      // Tambi√©n SUPER_ADMIN puede crear para cualquier usuario
      // Tambi√©n ADMIN_COUNTRY puede crear DISTRIBUTOR para su pa√≠s
      allow create: if (request.auth.uid == uid && request.auth != null) || 
                       isSuperAdmin() ||
                       (isAdminCountry() && request.resource.data.role == 'DISTRIBUTOR' && 
                        belongsToCountry(request.resource.data.countryId));

      // Actualizaci√≥n: El usuario puede actualizar su propio documento
      // SUPER_ADMIN puede actualizar cualquier usuario
      // ESPECIAL: El admin asignado puede actualizar el documento temporal (admin_pending_*)
      allow update: if request.auth.uid == uid || 
                       isSuperAdmin() ||
                       (uid.matches('admin_pending_.*') && 
                        request.resource.data.email == request.auth.token.email &&
                        resource.data.role == 'ADMIN_COUNTRY');

      // Eliminaci√≥n: Solo SUPER_ADMIN puede eliminar usuarios
      allow delete: if isSuperAdmin();
    }

    // ========== üè™ COLLECTION: stores ==========
    match /stores/{storeId} {
      // Lectura: La tienda puede leer su propio documento
      //          STORE puede leer tiendas con su mismo distribuidor (para ver otros tenderos)
      //          ADMIN_COUNTRY puede leer tiendas en su pa√≠s
      //          DISTRIBUTOR puede leer tiendas asignadas
      //          SUPER_ADMIN puede leer todo
      allow read: if ownsStore(storeId) ||
                     (isStore() && resource.data.distributorId == getUser().distributorId) ||
                     (isAdminCountry() && belongsToCountry(resource.data.countryId)) ||
                     (isDistributor() && resource.data.distributorId == request.auth.uid) ||
                     isSuperAdmin();

      // Escritura: Solo durante registro o SUPER_ADMIN
      // ‚ö†Ô∏è IMPORTANTE: Debe existir ADMIN_COUNTRY en ese pa√≠s
      allow create: if (request.auth.uid == storeId && 
                        hasCountryAdmin(request.resource.data.countryId)) || 
                       isSuperAdmin();

      // Actualizaci√≥n: La tienda puede actualizar ciertos campos
      //                ADMIN_COUNTRY puede activar/desactivar
      //                DISTRIBUTOR puede asignar promociones
      //                SUPER_ADMIN puede actualizar todo
      allow update: if (ownsStore(storeId) && request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['pointsMonth', 'address', 'status', 'distributorId', 'updatedAt'])) ||
                       (isAdminCountry() && belongsToCountry(resource.data.countryId) && 
                        request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['status', 'level'])) ||
                       isSuperAdmin();

      // Eliminaci√≥n: Solo SUPER_ADMIN
      allow delete: if isSuperAdmin();

      // Subcolecci√≥n: invoices
      match /invoices/{invoiceId} {
        // Lectura: La tienda puede ver sus propias facturas
        //          Admin del pa√≠s puede ver todas las facturas de su pa√≠s
        //          Distribuidor puede ver facturas de sus tiendas
        allow read: if ownsStore(storeId) ||
                       (isAdminCountry() && belongsToCountry(get(/databases/$(database)/documents/invoices/$(invoiceId)).data.countryId)) ||
                       (isDistributor() && get(/databases/$(database)/documents/invoices/$(invoiceId)).data.distributorId == request.auth.uid) ||
                       isSuperAdmin();

        // Escritura: Solo la tienda puede crear
        allow create: if ownsStore(storeId);

        // Actualizaci√≥n: No permitida desde cliente (solo Cloud Functions)
        allow update: if false;

        // Eliminaci√≥n: Solo tienda (para facturas pending) o SUPER_ADMIN
        allow delete: if (ownsStore(storeId) && resource.data.status == 'pending') ||
                         isSuperAdmin();
      }
    }

    // ========== üßæ COLLECTION: invoices ==========
    match /invoices/{invoiceId} {
      // Lectura: La tienda, admin del pa√≠s, distribuidor, SUPER_ADMIN
      allow read: if ownsStore(resource.data.storeId) ||
                     (isAdminCountry() && belongsToCountry(resource.data.countryId)) ||
                     (isDistributor() && resource.data.distributorId == request.auth.uid) ||
                     isSuperAdmin();

      // Escritura: Solo la tienda puede crear facturas
      allow create: if isStore() &&
                       ownsStore(request.resource.data.storeId) &&
                       request.resource.data.status == 'pending';

      // Actualizaci√≥n: No permitida desde cliente (solo Cloud Functions)
      allow update: if false;

      // Eliminaci√≥n: La tienda puede eliminar facturas pending, SUPER_ADMIN cualquier cosa
      allow delete: if (isStore() && ownsStore(resource.data.storeId) && resource.data.status == 'pending') ||
                       isSuperAdmin();
    }

    // ========== üì¶ COLLECTION: globalProducts ==========
    match /globalProducts/{productId} {
      // Lectura: Todos los usuarios autenticados pueden leer
      allow read: if isAuth();

      // Escritura: Solo SUPER_ADMIN
      allow create: if isSuperAdmin();
      allow update: if isSuperAdmin();
      allow delete: if isSuperAdmin();
    }

    // ========== üì¶ COLLECTION: countryProducts ==========
    match /countryProducts/{countryProductId} {
      // Lectura: Usuarios autenticados del pa√≠s + SUPER_ADMIN
      allow read: if belongsToCountry(resource.data.countryId) || isSuperAdmin();

      // Escritura: Solo SUPER_ADMIN o ADMIN_COUNTRY del pa√≠s
      allow create: if (isSuperAdmin()) ||
                       (isAdminCountry() && belongsToCountry(request.resource.data.countryId));

      allow update: if (isSuperAdmin()) ||
                       (isAdminCountry() && belongsToCountry(resource.data.countryId));

      allow delete: if isSuperAdmin();
    }

    // ========== üéÅ COLLECTION: globalRewards ==========
    match /globalRewards/{rewardId} {
      // Lectura: Todos los usuarios autenticados
      allow read: if isAuth();

      // Escritura: Solo SUPER_ADMIN
      allow create: if isSuperAdmin();
      allow update: if isSuperAdmin();
      allow delete: if isSuperAdmin();
    }

    // ========== üéÅ COLLECTION: countryRewards ==========
    match /countryRewards/{countryRewardId} {
      // Lectura: Usuarios del pa√≠s + SUPER_ADMIN
      allow read: if belongsToCountry(resource.data.countryId) || isSuperAdmin();

      // Escritura: SUPER_ADMIN o ADMIN_COUNTRY del pa√≠s
      allow create: if (isSuperAdmin()) ||
                       (isAdminCountry() && belongsToCountry(request.resource.data.countryId));

      allow update: if (isSuperAdmin()) ||
                       (isAdminCountry() && belongsToCountry(resource.data.countryId));

      allow delete: if isSuperAdmin();
    }

    // ========== üì¶ COLLECTION: distributorRewardStock ==========
    match /distributorRewardStock/{stockId} {
      // Lectura: El distribuidor puede ver su stock, admin del pa√≠s, SUPER_ADMIN
      allow read: if isDistributorId(resource.data.distributorId) ||
                     (isAdminCountry() && belongsToCountry(getUser().countryId)) ||
                     isSuperAdmin();

      // Escritura: Solo el distribuidor o SUPER_ADMIN
      allow create: if (isDistributorId(request.resource.data.distributorId)) ||
                       isSuperAdmin();

      allow update: if (isDistributorId(resource.data.distributorId)) ||
                       isSuperAdmin();

      allow delete: if isSuperAdmin();
    }

    // ========== üéÅ COLLECTION: rewardClaims ==========
    match /rewardClaims/{claimId} {
      // Lectura: La tienda puede ver sus reclamos
      //          Admin del pa√≠s puede ver reclamos en su pa√≠s
      //          Distribuidor puede ver reclamos asignados
      //          SUPER_ADMIN ve todo
      allow read: if ownsStore(resource.data.storeId) ||
                     (isAdminCountry() && belongsToCountry(resource.data.countryId)) ||
                     (isDistributor() && resource.data.distributorId == request.auth.uid) ||
                     isSuperAdmin();

      // Escritura: Solo tiendas pueden crear reclamos
      allow create: if isStore() && ownsStore(request.resource.data.storeId);

      // Actualizaci√≥n: No permitida desde cliente (Cloud Functions actualiza)
      allow update: if false;

      // Eliminaci√≥n: No permitida
      allow delete: if false;
    }

    // ========== üöö COLLECTION: deliveries ==========
    match /deliveries/{deliveryId} {
      // Lectura: Distribuidor asignado, admin del pa√≠s, SUPER_ADMIN
      allow read: if (isDistributor() && resource.data.distributorId == request.auth.uid) ||
                     (isAdminCountry() && belongsToCountry(resource.data.countryId)) ||
                     isSuperAdmin();

      // Escritura: Distribuidor crea, actualiza estado de entrega
      allow create: if isDistributor() && isDistributorId(request.resource.data.distributorId);

      // Actualizaci√≥n: Distribuidor actualiza estado, SUPER_ADMIN
      allow update: if (isDistributor() && resource.data.distributorId == request.auth.uid) ||
                       isSuperAdmin();

      // Eliminaci√≥n: Solo SUPER_ADMIN
      allow delete: if isSuperAdmin();
    }

    // ========== üßÆ COLLECTION: pointTransactions ==========
    match /pointTransactions/{transactionId} {
      // Lectura: La tienda ve sus transacciones, admin pa√≠s y distribuidor ven las de su √°mbito
      allow read: if ownsStore(resource.data.storeId) ||
                     (isAdminCountry() && belongsToCountry(resource.data.countryId)) ||
                     (isDistributor() && get(/databases/$(database)/documents/stores/$(resource.data.storeId)).data.distributorId == request.auth.uid) ||
                     isSuperAdmin();

      // Escritura: Solo Cloud Functions pueden crear (no permitir desde cliente)
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    // ========== üéØ COLLECTION: campaigns ==========
    match /campaigns/{campaignId} {
      // Lectura: Usuarios del pa√≠s + SUPER_ADMIN
      allow read: if belongsToCountry(resource.data.countryId) || isSuperAdmin();

      // Escritura: ADMIN_COUNTRY del pa√≠s o SUPER_ADMIN
      allow create: if (isSuperAdmin()) ||
                       (isAdminCountry() && belongsToCountry(request.resource.data.countryId));

      allow update: if (isSuperAdmin()) ||
                       (isAdminCountry() && belongsToCountry(resource.data.countryId));

      allow delete: if isSuperAdmin();
    }

    // ========== üè¢ COLLECTION: distributors ==========
    // üìù NOTA: Distribuidores creados SOLO por ADMIN_COUNTRY desde su panel
    // NO manualmente en la colecci√≥n. El admin regional crea desde su dashboard.
    match /distributors/{distributorId} {
      // Lectura: El distribuidor ve sus datos
      //          Admin del pa√≠s puede leer distribuidores de su pa√≠s
      //          STORE puede leer distribuidores que sirven su ciudad
      //          SUPER_ADMIN ve todo
      allow read: if isDistributorId(distributorId) ||
                     (isAdminCountry() && belongsToCountry(resource.data.countryId)) ||
                     (isStore() && belongsToCountry(resource.data.countryId)) ||
                     isSuperAdmin();

      // Queries: Permitir que ADMIN_COUNTRY busque distribuidores de su pa√≠s
      //          Permitir que STORE busque distribuidores de su pa√≠s
      allow list: if (isAdminCountry() && belongsToCountry(resource.data.countryId)) ||
                     (isStore() && belongsToCountry(resource.data.countryId)) ||
                     isSuperAdmin();

      // Creaci√≥n: SOLO ADMIN_COUNTRY o SUPER_ADMIN
      // NO permitido desde colecci√≥n manual - SOLO desde panel del admin
      allow create: if (isSuperAdmin()) ||
                       (isAdminCountry() && belongsToCountry(request.resource.data.countryId));

      // Actualizaci√≥n: ADMIN_COUNTRY del pa√≠s o SUPER_ADMIN
      allow update: if (isSuperAdmin()) ||
                       (isAdminCountry() && belongsToCountry(resource.data.countryId));

      // Eliminaci√≥n: Solo SUPER_ADMIN
      allow delete: if isSuperAdmin();
    }

    // ========== üåç COLLECTION: countries ==========
    match /countries/{countryId} {
      // Lectura: Todos los usuarios autenticados
      allow read: if isAuth();

      // Escritura: Solo SUPER_ADMIN
      allow create: if isSuperAdmin();
      allow update: if isSuperAdmin();
      allow delete: if isSuperAdmin();
    }

    // ========== üìç COLLECTION: regions ==========
    match /regions/{regionId} {
      // Lectura: Usuarios del pa√≠s + SUPER_ADMIN
      allow read: if belongsToCountry(resource.data.countryId) || isSuperAdmin();

      // Escritura: ADMIN_COUNTRY o SUPER_ADMIN
      allow create: if (isSuperAdmin()) ||
                       (isAdminCountry() && belongsToCountry(request.resource.data.countryId));

      allow update: if (isSuperAdmin()) ||
                       (isAdminCountry() && belongsToCountry(resource.data.countryId));

      allow delete: if isSuperAdmin();
    }

    // ========== üîê COLLECTION: tenderos_validos ‚ö†Ô∏è PROTEGIDA ==========
    // ‚ö†Ô∏è CR√çTICA: Esta colecci√≥n contiene c√≥digos pre-registrados
    // Lectura permitida para validar durante registro (sin autenticaci√≥n)
    // Escritura solo mediante Cloud Functions y Firebase Admin SDK
    match /tenderos_validos/{codigo} {
      // Lectura: P√öBLICA - Necesario para validar c√≥digos en registro antes de autenticar
      allow read: if true;

      // Escritura: NO permitida desde cliente
      allow create: if false;
      allow update: if false;
      allow delete: if false;

      // üìù Nota: Acceso de escritura solo mediante:
      // - Cloud Functions (tiene permisos de Admin)
      // - Firebase Admin SDK con serviceAccountKey
      // - Script de setup (loadTenderos.ts)
    }

    // ========== üî• DEFAULT: Denegar todo acceso no especificado ==========
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
